<!--
#  Copyright 2023 Karl Kegel
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
-->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driftool Analysis</title>
	<script src='https://cdn.plot.ly/plotly-2.27.0.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js'></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <style>
     .hidden{
            visibility: hidden;
        }
        .gone{
            display: none;
        }
        .container {
            display: flex;
            width: 100%;
        }
        .horizontal{
            flex-direction: row;
        }
        .vertical{
            flex-direction: column;
        }
        .grow{
            flex-grow: 2;
        }
        .half-vp{
            height: 43vh;
        }
        .blue-font{
            color: blue;
        }
        .red-font{
            color: red;
        }
        .w30{
            width: 30%;
        }

        .fullw{
            width: 100%;
        }

        .container{
            max-width: 100% !important;
        }
    
        .visualplot{
            width: 60vw !important;
            height: 85vh !important;
        }

        .w60{
            width: 60vw !important;
        }

        tr:nth-child(even) {background-color: #f2f2f2;}
    
    
    </style>

</head>

<script>
    var active_elem = undefined

    function show_env(branch_name){
        if(active_elem){
            active_elem.style.display = 'none';
            active_elem = undefined;
        }
        active_elem = document.getElementById('env-'+branch_name)
        active_elem.style.display = 'block'
    }
</script>

<body>
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
          <span class="navbar-brand mb-0 h1">Drift Analysis: <span class="red-font">sd = ${sd}</span> & <span class="blue-font">dd = ${dd}</span></span>
        </div>
      </nav>
    <div class="container horizontal">
            <div class="container vertical bordered w30">
                <table id="branch-table">
                    <tr>
                        <th>Branch</th>
                        <th>sd</th>
                        <th>dd</th>
                    </tr>
                        % for a in branch_array:
                        <tr>
                            <td><span onclick="show_env('${a}')">${a}</span></td>
                            <td><span id="marker-sd-${loop.index}" class="red-font hidden">&#x25A0;</span></td>
                            <td><span id="marker-dd-${loop.index}" class="blue-font hidden">&#x25A0;</span></td>
                        </tr>
                        % endfor
                </table>
                <h3>Analysis</h3>
                Click branch in above list to see results!
                <div>
                    % for branch_env in branch_distances:
                    <div id="env-${branch_env.branch}" class="gone bordered">
                        <strong>${branch_env.branch}</strong>
                        <table>
                            <tr>
                                <th>Peer</th>
                                <th>sd</th>
                                <th>dd</th>
                            </tr>
                            % for peer in branch_env.distances:
                                <tr>
                                    <td>${peer.peer_branch}</td>
                                    <td>${peer.sd}</td>
                                    <td>${peer.dd}</td>
                                </tr>
                            % endfor
                        </table>
                    </div>
                    % endfor
                </div>
            </div>
            <div class="container grow vertical bordered">
                <ul class="nav nav-pills mb-3 justify-content-end" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-sd-tab" data-bs-toggle="pill" data-bs-target="#pills-sd" type="button" role="tab" aria-controls="pills-sd" aria-selected="true">SD (Statement Conflicts)</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-dd-tab" data-bs-toggle="pill" data-bs-target="#pills-dd" type="button" role="tab" aria-controls="pills-dd" aria-selected="false">DD (Line Diff)</button>
                    </li>
                  </ul>
                  <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade  full-h" id="pills-sd" role="tabpanel" aria-labelledby="pills-sd-tab" tabindex="0">
                        <div id='conflict-div' class='bordered visualplot'><!-- Plotly chart will be drawn inside this DIV --></div>
                    </div>
                    <div class="tab-pane fade show active full-h" id="pills-dd" role="tabpanel" aria-labelledby="pills-dd-tab" tabindex="0">
                        <div id='difference-div' class='bordered visualplot'><!-- Plotly chart will be drawn inside this DIV --></div>
                    </div>
                  </div>
            </div>
        
    </div>
	
</body>

<script>
        const number_branches = ${number_branches}

        const embedding_conflicts_3d = JSON.parse("${sd_embeddings}")
        const embedding_differences_3d = JSON.parse("${dd_embeddings}")

        function highlight_branch(index, mode){
            console.log(index, mode)
            for(var i = 0; i < number_branches; i++){
                const id = "marker-" + mode + "-" + i
                const elem = document.getElementById(id)
                if(index.includes(i)){
                    elem.style.visibility = 'visible';
                }else{
                    elem.style.visibility = 'hidden'
                }
            }
        }

        var trace_conflicts = {
            x: embedding_conflicts_3d.map(d => d[0]), y: embedding_conflicts_3d.map(d => d[1]), z: embedding_conflicts_3d.map(d => d[2]),
            mode: 'markers',
            hoverinfo:'none',
            marker: {
                size: 12,
                color: 'rgb(255,0,50)',
                opacity: 0.4},
            type: 'scatter3d'
        };

        var trace_differences = {
            x: embedding_differences_3d.map(d => d[0]), y: embedding_differences_3d.map(d => d[1]), z: embedding_differences_3d.map(d => d[2]),
            mode: 'markers',
            hoverinfo:'none',
            marker: {
                size: 12,
                color: 'rgb(0,0,255)',
                opacity: 0.4},
            type: 'scatter3d'
        };

        console.log(trace_conflicts)
        console.log(trace_differences)

        var data_conflicts = [trace_conflicts];
        var data_differences = [trace_differences];

        var layout = {margin: {
            l: 0,
            r: 0,
            b: 0,
            t: 0
        }};

        Plotly.newPlot('conflict-div', data_conflicts, layout);
        Plotly.newPlot('difference-div', data_differences, layout);

        document.getElementById('conflict-div').on('plotly_click', function(data){
            var pt = [
                undefined,
                undefined,
                undefined
            ];
            for(var i=0; i < data.points.length; i++){
                pt[0] = data.points[i].x
                pt[1] = data.points[i].y
                pt[2] = data.points[i].z
            }

            var branches = []

            for(var i=0; i < embedding_conflicts_3d.length; i++){
                var e = embedding_conflicts_3d[i]
                if(e[0] === pt[0] && e[1] === pt[1] && e[2] === pt[2]){
                    branches.push(i)
                }
            }
            console.log("on-click branch " + JSON.stringify(branches))
            highlight_branch(branches, "sd")
        });

        document.getElementById('difference-div').on('plotly_click', function(data){
            var pt = [
                undefined,
                undefined,
                undefined
            ];
            for(var i=0; i < data.points.length; i++){
                pt[0] = data.points[i].x
                pt[1] = data.points[i].y
                pt[2] = data.points[i].z
            }

            var branches = []

            for(var i=0; i < embedding_differences_3d.length; i++){
                var e = embedding_differences_3d[i]
                if(e[0] === pt[0] && e[1] === pt[1] && e[2] === pt[2]){
                    branches.push(i)
                }
            }
            console.log("on-click branch " + JSON.stringify(branches))
            highlight_branch(branches, "dd")
        });


</script>
</html>